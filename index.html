<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>YouGlish ‚Äì Multi Video + Clean Transcript</title>
  <style>
    :root {
      --primary: #1677ff;
      --bg: #f5f5f5;
      --card-bg: #ffffff;
      --border: #e5e7eb;
      --text-main: #111827;
      --text-sub: #6b7280;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: var(--bg);
      color: var(--text-main);
    }

    .page {
      max-width: 1100px;
      margin: 24px auto;
      padding: 0 16px 40px;
    }

    h1 {
      text-align: center;
      font-size: 24px;
      margin-bottom: 16px;
    }

    .search-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
      margin-bottom: 16px;
    }

    .search-row input[type="text"] {
      min-width: 260px;
      padding: 8px 10px;
      font-size: 16px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      outline: none;
    }

    .search-row input[type="text"]:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(22, 119, 255, 0.2);
    }

    .search-row select {
      padding: 8px 10px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      font-size: 14px;
      background: #fff;
    }

    .search-row button {
      padding: 8px 16px;
      font-size: 16px;
      border-radius: 6px;
      border: none;
      background: var(--primary);
      color: #fff;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .search-row button[disabled] {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .search-row button:hover:not([disabled]) {
      background: #125ecc;
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(0, 3fr) minmax(0, 2fr);
      gap: 16px;
      align-items: flex-start;
    }

    @media (max-width: 900px) {
      .layout {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .card {
      background: var(--card-bg);
      border-radius: 10px;
      padding: 14px 16px;
      border: 1px solid var(--border);
      box-shadow: 0 1px 3px rgba(15, 23, 42, 0.08);
    }

    .card h2 {
      font-size: 18px;
      margin: 0 0 8px;
    }

    .meta-row {
      font-size: 14px;
      margin: 4px 0;
    }

    .meta-label {
      font-weight: 600;
      color: var(--text-sub);
      margin-right: 4px;
    }

    .meta-value {
      color: var(--text-main);
      word-break: break-word;
    }

    .status {
      margin-top: 8px;
      font-size: 13px;
      color: var(--text-sub);
    }

    .status strong {
      color: var(--primary);
    }

    .widget-wrapper {
      border-radius: 10px;
      overflow: hidden;
      background: #000;
      box-shadow: 0 1px 4px rgba(15, 23, 42, 0.18);
    }

    #yg-widget {
      width: 100%;
      max-width: 100%;
    }

    a {
      color: var(--primary);
      text-decoration: none;
    }

    a:hover {
      text-decoration: underline;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 12px;
      background: #eff6ff;
      color: #1d4ed8;
    }

    /* List nhi·ªÅu video */
    .videos-list {
      margin-top: 24px;
    }

    .video-item {
      border-top: 1px solid #e5e7eb;
      padding-top: 12px;
      margin-top: 12px;
    }

    .video-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
      flex-wrap: wrap;
    }

    .video-title {
      font-weight: 600;
      font-size: 15px;
    }

    .video-transcript {
      background: #f9fafb;
      border-radius: 8px;
      padding: 8px 10px;
      border: 1px solid #e5e7eb;
      font-size: 14px;
      white-space: pre-wrap;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 11px;
      background: #f3f4f6;
      color: #4b5563;
    }
  </style>
</head>
<body>
  <div class="page">
    <h1>YouGlish ‚Äì Multi Video + Clean Transcript</h1>

    <!-- Search area -->
    <div class="search-row">
      <input
        id="queryInput"
        type="text"
        placeholder="Nh·∫≠p t·ª´/c·ª•m t·ª´ (vd: courage, opportunity...)"
      />
      <select id="langSelect">
        <option value="english">English</option>
        <option value="vietnamese">Vietnamese</option>
        <option value="french">French</option>
        <option value="spanish">Spanish</option>
      </select>
      <button id="searchBtn" disabled>üîç Search</button>
    </div>

    <div class="layout">
      <!-- LEFT: Player + meta -->
      <div>
        <div class="card" style="margin-bottom: 12px">
          <h2>Current Video</h2>

          <div class="meta-row">
            <span class="meta-label">Title:</span>
            <span class="meta-value" id="metaTitle">Ch∆∞a c√≥ k·∫øt qu·∫£</span>
          </div>

          <div class="meta-row">
            <span class="meta-label">Category:</span>
            <span class="meta-value" id="metaCategory">
              <span class="pill">‚Äì</span>
            </span>
          </div>

          <div class="meta-row">
            <span class="meta-label">Video URL:</span>
            <span class="meta-value" id="metaVideoUrl">‚Äì</span>
          </div>

          <div class="status" id="metaStatus">ƒêang t·∫£i YouGlish widget...</div>
        </div>

        <!-- Player -->
        <div class="widget-wrapper">
          <div id="yg-widget"></div>
        </div>
      </div>

      <!-- RIGHT: Danh s√°ch nhi·ªÅu video + transcript -->
      <div class="card">
        <h2>All Videos & Clean Transcript</h2>
        <div class="status" style="margin-bottom: 8px;">
          M·ªói khi b·∫°n b·∫•m Next/Previous trong player, video m·ªõi s·∫Ω ƒë∆∞·ª£c th√™m b√™n d∆∞·ªõi.
        </div>
        <div id="videosList" class="videos-list">
          <div class="video-item">
            <div class="video-title">Ch∆∞a c√≥ video n√†o.</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Load widget.js async
    (function loadYouglishScript() {
      var tag = document.createElement("script");
      tag.src = "https://youglish.com/public/emb/widget.js";
      var firstScriptTag = document.getElementsByTagName("script")[0];
      firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
    })();

    let widget = null;
    let isReady = false;

    const queryInput = document.getElementById("queryInput");
    const langSelect = document.getElementById("langSelect");
    const searchBtn = document.getElementById("searchBtn");

    const metaTitle = document.getElementById("metaTitle");
    const metaCategory = document.getElementById("metaCategory");
    const metaVideoUrl = document.getElementById("metaVideoUrl");
    const metaStatus = document.getElementById("metaStatus");
    const videosListEl = document.getElementById("videosList");

    // L∆∞u transcript theo t·ª´ng video
    // videosMap[videoId] = { index, videoId, url, transcripts: [] }
    const videosMap = {};
    let currentVideoId = null;
    let currentQuery = "";
    let videoOrder = 0;

    // H√†m n√†y global, YouGlish s·∫Ω g·ªçi khi API s·∫µn s√†ng
    function onYouglishAPIReady() {
      console.log("YouGlish API ready");

      widget = new YG.Widget("yg-widget", {
        width: 800,
        components: 4 + 8 + 64, // title + caption + controls
        autoStart: 1,
        events: {
          onFetchDone,
          onVideoChange,
          onCaptionChange,
          onError,
        },
      });

      isReady = true;
      searchBtn.disabled = false;
      metaStatus.textContent = "Widget ƒë√£ s·∫µn s√†ng. Nh·∫≠p t·ª´ v√† b·∫•m Search.";
    }

    // Sau khi fetch xong cho query
    function onFetchDone(event) {
      if (event.totalResult === 0) {
        metaTitle.textContent = "Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£";
        metaCategory.innerHTML = '<span class="pill">No result</span>';
        metaVideoUrl.textContent = "‚Äì";
        metaStatus.textContent = "";
        clearVideosList("Kh√¥ng c√≥ video n√†o cho query n√†y.");
        return;
      }

      currentQuery = event.query;

      const titleText = `How to say "${event.query}" in ${event.lang} (${event.totalResult} results)`;
      metaTitle.textContent = titleText;

      const cat = event.accent
        ? `${event.lang} ‚Äì ${event.accent}`
        : event.lang;
      metaCategory.innerHTML = `<span class="pill">${cat}</span>`;

      metaStatus.innerHTML =
        `C√≥ <strong>${event.totalResult}</strong> k·∫øt qu·∫£.` +
        ` D√πng n√∫t Next / Previous trong player ƒë·ªÉ ƒë·ªïi video.`;

      // M·ªói query m·ªõi ‚Üí reset danh s√°ch video
      resetVideos();
    }

    // Khi ƒë·ªïi sang video kh√°c
    function onVideoChange(event) {
      currentVideoId = event.video;

      if (!currentVideoId) {
        metaVideoUrl.textContent = "‚Äì";
        return;
      }

      const url = `https://www.youtube.com/watch?v=${currentVideoId}`;
      metaVideoUrl.innerHTML =
        `<a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a>`;

      // N·∫øu video n√†y ch∆∞a c√≥ trong map ‚Üí th√™m m·ªõi
      if (!videosMap[currentVideoId]) {
        videoOrder += 1;
        videosMap[currentVideoId] = {
          index: videoOrder,
          videoId: currentVideoId,
          url,
          transcripts: [],
        };
      }

      renderVideosList();
    }

    // Khi caption thay ƒë·ªïi
    function onCaptionChange(event) {
      if (!currentVideoId || !videosMap[currentVideoId]) return;

      // L√†m s·∫°ch caption
      const raw = event.caption || "";

      const clean = cleanCaptionText(raw);
      if (!clean) return;

      const arr = videosMap[currentVideoId].transcripts;
      // Tr√°nh b·ªã spam l·∫∑p d√≤ng li√™n t·ª•c
      if (arr.length === 0 || arr[arr.length - 1] !== clean) {
        arr.push(clean);
        renderVideosList();
      }
    }

    function onError(event) {
      console.error("YouGlish error:", event.code);
      metaStatus.innerHTML =
        `<span style="color:#b91c1c">L·ªói YouGlish (code: ${event.code})</span>`;
    }

    // ===========================
    // Helpers
    // ===========================

    function cleanCaptionText(text) {
      // 1) B·ªè [[[ ]]]
      let cleaned = text.replace(/\[\[\[/g, "").replace(/\]\]\]/g, "");

      // 2) decode %20, %3F, ... (n·∫øu c√≥)
      try {
        cleaned = decodeURIComponent(cleaned);
      } catch (e) {
        // n·∫øu decode l·ªói th√¨ b·ªè qua
      }

      // 3) B·ªè k√Ω t·ª± control, ƒë·ªÉ l·∫°i ch·ªØ, s·ªë, d·∫•u c√¢u c∆° b·∫£n
      cleaned = cleaned.replace(/[^\w√Ä-·ªπ.,?!'"() \-]/g, " ");

      // 4) G·ªôp kho·∫£ng tr·∫Øng, trim
      cleaned = cleaned.replace(/\s+/g, " ").trim();

      return cleaned;
    }

    function escapeHtml(str) {
      return str
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");
    }

    function resetVideos() {
      for (const key in videosMap) {
        delete videosMap[key];
      }
      currentVideoId = null;
      videoOrder = 0;
      clearVideosList("Ch∆∞a c√≥ video n√†o. H√£y b·∫•m Play/Next trong player.");
    }

    function clearVideosList(message) {
      videosListEl.innerHTML =
        `<div class="video-item"><div class="video-title">${escapeHtml(
          message
        )}</div></div>`;
    }

    function renderVideosList() {
      const entries = Object.values(videosMap).sort(
        (a, b) => a.index - b.index
      );

      if (!entries.length) {
        clearVideosList("Ch∆∞a c√≥ video n√†o ƒë∆∞·ª£c xem.");
        return;
      }

      videosListEl.innerHTML = entries
        .map((v) => {
          const transcriptText = v.transcripts.join(" ");

          return `
            <div class="video-item">
              <div class="video-header">
                <div class="video-title">
                  Video #${v.index}
                  <span class="badge">${currentQuery || "query"}</span>
                </div>
                <div>
                  <a href="${v.url}" target="_blank" rel="noopener noreferrer">
                    ${v.url}
                  </a>
                </div>
              </div>
              <div class="video-transcript">
                ${transcriptText
                  ? escapeHtml(transcriptText)
                  : "<em>Ch∆∞a c√≥ subtitle n√†o ƒë∆∞·ª£c load.</em>"}
              </div>
            </div>
          `;
        })
        .join("");
    }

    // ===========================
    // Search
    // ===========================
    searchBtn.addEventListener("click", () => {
      const q = queryInput.value.trim();
      const lang = langSelect.value;

      if (!q) {
        alert("Nh·∫≠p t·ª´/c·ª•m t·ª´ tr∆∞·ªõc ƒë√£.");
        return;
      }
      if (!isReady || !widget) {
        alert("Widget ch∆∞a s·∫µn s√†ng, th·ª≠ reload l·∫°i trang.");
        return;
      }

      metaTitle.textContent = "ƒêang t√¨m ki·∫øm...";
      metaCategory.innerHTML = '<span class="pill">Loading...</span>';
      metaVideoUrl.textContent = "‚Äì";
      metaStatus.textContent = "";
      resetVideos();

      widget.fetch(q, lang);
    });

    queryInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") searchBtn.click();
    });
  </script>
</body>
</html>
